<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asta Fanta App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId;
        let isOnline = false;

        const FIREBASE_CONFIG_KEY = `firebase-config-${appId}`;

        // Funzione per inizializzare Firebase
        async function initializeFirebase() {
            try {
                let config = null;

                // 1. Prova a usare la configurazione di ambiente
                if (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) {
                    config = JSON.parse(__firebase_config);
                    console.log("Configurazione Firebase caricata dall'ambiente.");
                } 
                // 2. Altrimenti, prova a caricare da localStorage
                else if (localStorage.getItem(FIREBASE_CONFIG_KEY)) {
                    config = JSON.parse(localStorage.getItem(FIREBASE_CONFIG_KEY));
                    console.log("Configurazione Firebase caricata da localStorage.");
                }

                if (config) {
                    const app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                    isOnline = true;
                    console.log("Firebase inizializzato. ID utente:", userId);
                    setupListeners();
                    document.getElementById('connection-status').textContent = 'Connesso a Firebase';
                    document.getElementById('connection-status').classList.remove('bg-red-500');
                    document.getElementById('connection-status').classList.add('bg-green-500');
                    elements.configModal.classList.add('hidden');
                    appState.currentScreen = 'auth'; // Torna alla schermata di autenticazione per procedere
                    render();
                } else {
                    throw new Error('Credenziali Firebase non disponibili.');
                }

            } catch (error) {
                console.error("Errore generico durante l'inizializzazione di Firebase:", error);
                document.getElementById('connection-status').textContent = 'Disconnesso da Firebase';
                document.getElementById('connection-status').classList.remove('bg-green-500');
                document.getElementById('connection-status').classList.add('bg-red-500');
                isOnline = false;
                userId = 'offline-user';
                db = null;
                auth = null;
                showModal("Errore durante l'inizializzazione di Firebase. Inserisci le tue credenziali per connetterti.", true);
            }
        }

        const appState = {
            currentScreen: 'auth',
            participantName: '',
            participantCredits: 0,
            currentPlayer: '', 
            bids: [],
            totalParticipants: 0,
            hasSubmittedBid: false,
            winningBid: null,
            winningParticipant: null,
            allParticipants: []
        };

        const elements = {
            authScreen: document.getElementById('auth-screen'),
            mainScreen: document.getElementById('main-screen'),
            nameInput: document.getElementById('name-input'),
            saveNameBtn: document.getElementById('save-name-btn'),
            displayName: document.getElementById('display-name'),
            displayUserId: document.getElementById('display-user-id'),
            myCreditsDisplay: document.getElementById('my-credits-display'),
            currentPlayerDisplay: document.getElementById('current-player-display'),
            bidForm: document.getElementById('bid-form'),
            bidAmountInput: document.getElementById('bid-amount-input'),
            passBidBtn: document.getElementById('pass-bid-btn'),
            submitBidBtn: document.getElementById('submit-bid-btn'),
            biddingStatus: document.getElementById('bidding-status'),
            resultsScreen: document.getElementById('results-screen'),
            winningBidDisplay: document.getElementById('winning-bid-display'),
            winningParticipantDisplay: document.getElementById('winning-participant-display'),
            waitingMessage: document.getElementById('waiting-message'),
            startNewAuctionBtn: document.getElementById('start-new-auction-btn'),
            participantsList: document.getElementById('participants-list'),
            configModal: document.getElementById('config-modal'),
            configTextarea: document.getElementById('firebase-config-textarea'),
            saveConfigBtn: document.getElementById('save-config-btn'),
            openConfigModalBtn: document.getElementById('open-config-modal-btn'),
            connectionStatus: document.getElementById('connection-status')
        };

        function render() {
            elements.authScreen.classList.add('hidden');
            elements.mainScreen.classList.add('hidden');
            elements.resultsScreen.classList.add('hidden');
            elements.biddingStatus.classList.add('hidden');
            elements.waitingMessage.classList.add('hidden');
            elements.bidForm.classList.add('hidden');

            elements.participantsList.innerHTML = '';
            appState.allParticipants.forEach(p => {
                const li = document.createElement('li');
                li.className = 'py-2 px-4 rounded-lg';
                if (p.userId === userId) {
                    li.className += ' bg-indigo-100 text-indigo-800 font-semibold';
                }
                li.textContent = `${p.name} (ID: ${p.userId})`;
                elements.participantsList.appendChild(li);
            });

            switch (appState.currentScreen) {
                case 'auth':
                    elements.authScreen.classList.remove('hidden');
                    break;
                case 'main':
                    elements.mainScreen.classList.remove('hidden');
                    elements.displayName.textContent = appState.participantName;
                    elements.displayUserId.textContent = `Il tuo ID: ${userId}`;
                    elements.myCreditsDisplay.textContent = `Crediti rimanenti: ${appState.participantCredits}`;

                    if (appState.bids.length === appState.totalParticipants && appState.totalParticipants > 0) {
                        elements.resultsScreen.classList.remove('hidden');
                        elements.winningBidDisplay.textContent = appState.winningBid ? `Offerta: €${appState.winningBid}` : 'Nessuna offerta valida';
                        elements.winningParticipantDisplay.textContent = appState.winningParticipant ? `Vincitore: ${appState.winningParticipant}` : '';
                    } else if (appState.hasSubmittedBid) {
                        elements.waitingMessage.classList.remove('hidden');
                    } else {
                        elements.bidForm.classList.remove('hidden');
                        elements.biddingStatus.textContent = `Offerte ricevute: ${appState.bids.length} di ${appState.totalParticipants}`;
                        elements.biddingStatus.classList.remove('hidden');
                    }
                    break;
            }

            elements.saveNameBtn.disabled = !isOnline;
            elements.submitBidBtn.disabled = !isOnline;
            elements.passBidBtn.disabled = !isOnline;
            elements.startNewAuctionBtn.disabled = !isOnline;
        }

        async function saveParticipantName() {
            if (!isOnline) {
                showModal('Funzionalità non disponibile, connettiti prima a Firebase.');
                return;
            }
            const name = elements.nameInput.value.trim();
            if (name) {
                appState.participantName = name;
                
                const initialCredits = 300;
                
                const privateProfileRef = doc(db, 'artifacts', appId, 'users', userId);
                const publicParticipantRef = doc(db, 'artifacts', appId, 'public', 'data', 'participants', userId);
                
                await setDoc(privateProfileRef, { name: name, userId: userId, credits: initialCredits });
                await setDoc(publicParticipantRef, { name: name, userId: userId });

                appState.currentScreen = 'main';
                render();
            } else {
                showModal('Inserisci un nome valido.');
            }
        }

        async function submitBid() {
            if (!isOnline) {
                showModal('Funzionalità non disponibile, connettiti prima a Firebase.');
                return;
            }
            const bidAmount = parseInt(elements.bidAmountInput.value, 10);
            if (isNaN(bidAmount) || bidAmount < 0) {
                showModal('Inserisci un importo valido.');
                return;
            }
            appState.hasSubmittedBid = true;
            render();
            
            const auctionRef = doc(db, 'artifacts', appId, 'public', 'data', 'auction_rounds', 'auction_state');
            const currentData = await getDoc(auctionRef);
            const currentBids = currentData.exists() ? (currentData.data().bids || []) : [];

            const updatedBids = [...currentBids, { userId: userId, name: appState.participantName, amount: bidAmount }];
            await setDoc(auctionRef, { bids: updatedBids }, { merge: true });
        }

        async function passBid() {
            if (!isOnline) {
                showModal('Funzionalità non disponibile, connettiti prima a Firebase.');
                return;
            }
            appState.hasSubmittedBid = true;
            render();
            const auctionRef = doc(db, 'artifacts', appId, 'public', 'data', 'auction_rounds', 'auction_state');
            const currentData = await getDoc(auctionRef);
            const currentBids = currentData.exists() ? (currentData.data().bids || []) : [];

            const updatedBids = [...currentBids, { userId: userId, name: appState.participantName, amount: 0 }];
            await setDoc(auctionRef, { bids: updatedBids }, { merge: true });
        }

        async function startNewAuction() {
            if (!isOnline) {
                showModal('Funzionalità non disponibile, connettiti prima a Firebase.');
                return;
            }
            const auctionRef = doc(db, 'artifacts', appId, 'public', 'data', 'auction_rounds', 'auction_state');
            await setDoc(auctionRef, {
                bids: [],
                winningBid: null,
                winningParticipant: null
            });
            appState.hasSubmittedBid = false;
            elements.bidAmountInput.value = '';
            render();
        }

        async function calculateAndSaveWinner(bids) {
            if (!isOnline) return { winningBid: null, winningParticipantName: null };

            let winningBid = 0;
            let winningParticipantId = null;
            let winningParticipantName = null;

            bids.forEach(bid => {
                if (bid.amount > winningBid) {
                    winningBid = bid.amount;
                    winningParticipantId = bid.userId;
                    winningParticipantName = bid.name;
                }
            });

            if (winningParticipantId) {
                const winnerRef = doc(db, 'artifacts', appId, 'users', winningParticipantId);
                const winnerSnap = await getDoc(winnerRef);
                if (winnerSnap.exists()) {
                    const currentCredits = winnerSnap.data().credits;
                    const newCredits = currentCredits - winningBid;
                    await updateDoc(winnerRef, { credits: newCredits });
                }
            }

            return { winningBid, winningParticipantName };
        }

        function setupListeners() {
            if (!isOnline) return;
            const participantRef = doc(db, 'artifacts', appId, 'users', userId);
            onSnapshot(participantRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().name) {
                    appState.participantName = docSnap.data().name;
                    appState.participantCredits = docSnap.data().credits || 0;
                    appState.currentScreen = 'main';
                    setupAuctionStateListener();
                    setupParticipantsListener();
                    render();
                } else {
                    appState.currentScreen = 'auth';
                    render();
                }
            });
        }

        function setupAuctionStateListener() {
            if (!isOnline) return;
            const auctionRef = doc(db, 'artifacts', appId, 'public', 'data', 'auction_rounds', 'auction_state');
            onSnapshot(auctionRef, async (docSnap) => {
                const data = docSnap.data();
                if (data) {
                    appState.bids = data.bids || [];
                    if (appState.bids.length === appState.totalParticipants && appState.totalParticipants > 0) {
                        const { winningBid, winningParticipantName } = await calculateAndSaveWinner(appState.bids);
                        appState.winningBid = winningBid;
                        appState.winningParticipant = winningParticipantName;
                        appState.hasSubmittedBid = false;
                        elements.bidAmountInput.value = '';
                    }
                    render();
                }
            });
        }

        function setupParticipantsListener() {
            if (!isOnline) return;
            const participantsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'participants');
            onSnapshot(participantsCollection, (querySnapshot) => {
                appState.allParticipants = [];
                querySnapshot.forEach(doc => {
                    appState.allParticipants.push(doc.data());
                });
                appState.totalParticipants = appState.allParticipants.length;
                render();
            });
        }

        function showModal(message, isConfig = false) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            const closeModalBtn = document.getElementById('close-modal-btn');
            modalMessage.textContent = message;
            if (isConfig) {
                elements.configModal.classList.remove('hidden');
            } else {
                modal.classList.remove('hidden');
            }
            closeModalBtn.onclick = () => modal.classList.add('hidden');
        }

        async function saveConfig() {
            try {
                const config = JSON.parse(elements.configTextarea.value);
                localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(config));
                elements.configModal.classList.add('hidden');
                await initializeFirebase();
            } catch (error) {
                showModal('Configurazione non valida. Assicurati che sia un oggetto JSON corretto.');
            }
        }
        
        window.onload = async () => {
            await initializeFirebase();
        };

        elements.saveNameBtn.addEventListener('click', saveParticipantName);
        elements.bidForm.addEventListener('submit', (e) => { e.preventDefault(); submitBid(); });
        elements.passBidBtn.addEventListener('click', passBid);
        elements.startNewAuctionBtn.addEventListener('click', startNewAuction);
        elements.saveConfigBtn.addEventListener('click', saveConfig);
        elements.openConfigModalBtn.addEventListener('click', () => {
            elements.configModal.classList.remove('hidden');
            const savedConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
            if (savedConfig) {
                elements.configTextarea.value = savedConfig;
            }
        });

    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4 flex flex-col items-center justify-center min-h-screen">

    <!-- Status di connessione -->
    <div id="connection-status" class="fixed top-4 right-4 p-2 rounded-lg text-white font-semibold text-sm transition-colors duration-200">
        Disconnesso da Firebase
    </div>
    
    <!-- Pulsante per aprire la configurazione -->
    <button id="open-config-modal-btn" class="fixed bottom-4 right-4 bg-gray-700 text-white p-3 rounded-full shadow-lg hover:bg-gray-800 transition-colors duration-200 z-50">
        Configura
    </button>

    <!-- Schermata Autenticazione Nome -->
    <div id="auth-screen" class="hidden bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-600">Asta Fanta</h1>
        <p class="text-center text-gray-600 mb-4">Inserisci il tuo nome per iniziare.</p>
        <div class="space-y-4">
            <input type="text" id="name-input" placeholder="Il tuo nome" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="save-name-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-200" disabled>Salva Nome</button>
        </div>
    </div>

    <!-- Schermata Principale -->
    <div id="main-screen" class="hidden bg-white p-8 rounded-xl shadow-lg w-full max-w-lg text-center">
        <div class="mb-4">
            <h2 id="display-name" class="text-2xl font-bold text-indigo-600"></h2>
            <p id="display-user-id" class="text-sm text-gray-500"></p>
            <p id="my-credits-display" class="text-md font-medium text-gray-700 mt-2"></p>
        </div>

        <div class="mb-6">
            <p id="current-player-display" class="text-2xl font-extrabold text-gray-900 mt-2"></p>
        </div>

        <!-- Sezione per fare l'offerta -->
        <div id="bidding-section">
            <p id="bidding-status" class="text-md text-gray-500 font-medium my-4 hidden"></p>
            <p id="waiting-message" class="text-md text-gray-500 font-medium my-4 hidden">Offerta inviata. Attendi gli altri partecipanti...</p>

            <form id="bid-form" class="space-y-4 hidden">
                <input type="number" id="bid-amount-input" placeholder="La tua offerta in €" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="flex space-x-2">
                    <button type="button" id="pass-bid-btn" class="flex-1 bg-red-500 text-white p-3 rounded-lg font-semibold hover:bg-red-600 transition-colors duration-200" disabled>Non Offro</button>
                    <button type="submit" id="submit-bid-btn" class="flex-1 bg-green-500 text-white p-3 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-200" disabled>Offro</button>
                </div>
            </form>
        </div>
        
        <!-- Schermata Risultati -->
        <div id="results-screen" class="hidden my-6">
            <h3 class="text-xl font-semibold text-gray-700">Risultato Asta</h3>
            <p id="winning-participant-display" class="text-2xl font-bold text-green-600 mt-2"></p>
            <p id="winning-bid-display" class="text-xl text-gray-800 mt-1"></p>
            <button id="start-new-auction-btn" class="w-full mt-4 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200" disabled>Avvia Nuova Asta</button>
        </div>

        <!-- Sezione Lista Partecipanti -->
        <div class="mt-8 pt-4 border-t-2 border-gray-200">
            <h4 class="text-lg font-bold text-gray-700">Partecipanti</h4>
            <ul id="participants-list" class="mt-4 space-y-2 text-left"></ul>
        </div>
    </div>
    
    <!-- Modal per messaggi di errore/info -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <p id="modal-message" class="text-center text-gray-700 font-medium mb-4"></p>
            <div class="text-center">
                <button id="close-modal-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">OK</button>
            </div>
        </div>
    </div>

    <!-- Modal per la configurazione di Firebase -->
    <div id="config-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
            <h3 class="text-2xl font-bold text-center mb-4 text-indigo-600">Configura Firebase</h3>
            <p class="text-center text-gray-600 mb-6">Incolla qui l'oggetto di configurazione JSON dal tuo progetto Firebase. Trovalo su **Impostazioni progetto** -> **Le tue app**.</p>
            <div class="space-y-4">
                <textarea id="firebase-config-textarea" class="w-full h-48 p-3 border border-gray-300 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <button id="save-config-btn" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors duration-200">Salva Configurazione</button>
            </div>
            <div class="mt-4 text-center text-gray-500">
                <p>Una volta salvato, ricarica la pagina.</p>
            </div>
        </div>
    </div>

</body>
</html>
